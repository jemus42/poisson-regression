---
title: "Poisson Regression"
subtitle: " — und ihre Leiden"
author: "Lukas Burk"
date: "`r format(Sys.time(), '%F %T')`"
output: 
  revealjs::revealjs_presentation:
    slide_level: 1
    incremental: true
    fig_caption: true
    transition: "slide"
    fig_height: 5
    reveal_options:
      navigationMode: "linear"
    self_contained: false
    lib_dir: "libs"
  slidy_presentation:
    incremental: true
    footer: "Lukas Burk"
    fig_caption: true
  ioslides_presentation:
    incremental: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, message = FALSE, warning = FALSE
)

# library(DiagrammeR)
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(firasans)
library(broom)
library(kableExtra)

extrafont::loadfonts(quiet = TRUE)
library(firasans) # Install via  remotes::install_github("hrbrmstr/firasans")

theme_set(
   theme_ipsum_fsc()
)

fish <- readRDS(here::here("data/fish.rds"))
```

# Intro

Hier, in kürze:

1. Das Poisson-Modell im groben
2. "Aber aber…": Verletzte Annahmen und andere Unannehmlichkeiten
3. Dispersion: Schade eigentlich
4. Nullen: ಠ_ಠ 


# Zähldaten

Wir haben eine zu erklärende Variable $Y$, was machen wir damit?  
In einer perfekten Welt:

- $Y \in \mathbb{R}$: Lineares Modell
- $Y \in [0, 1]$: Logistische Regression
- $Y \in \mathbb{N}_0$: Poisson Regression

# Poisson Modell

$$\begin{aligned}
Y \sim \mathrm{Poisson}(\mu): \quad
\mathrm{P}(Y = y) = \frac{\mu^y \exp(-\mu)}{y!}, \quad y \in \mathbb{N}_0
\end{aligned}$$

```{r poissondists, fig.cap="Poisson-Verteilungen mit ausgewählten Parametern."}
map_df(c(0.5, 1, 2, 5, 10, 15), ~{
  tibble(
    mu = .x,
    x = 0:20,
    poi = dpois(x, mu)
  )
}) %>%
  ggplot(aes(x = x, y = poi, color = factor(mu), fill = factor(mu))) +
  geom_path(aes(group = mu), linetype = "dotted") +
  geom_point(shape = 21, color = "black", size = 2.5, stroke = .2) +
  #geom_segment(aes(x = x, xend = x, y = 0 , yend = poi)) +
  scale_color_viridis_d(direction = -1, guide = FALSE) +
  scale_fill_viridis_d(
    direction = -1, guide = guide_legend(
      keywidth = .5,
      nrow = 1,
      direction = "horizontal"
      )
  ) +
  labs(
    title = "Poi(\u00b5)",
    x = "y", y = "Poi(y, \u00b5)", fill = "\u00b5"
  ) +
  theme(legend.position = c(.7, 1))
```


# Beispiel: Fischfang

Datensatz `fish`: An einem Wochenendausflug in einen Park wurden 250 Gruppen nach der Anzahl ihrer geangelten Fische befragt

- `count`: Anzahl gefangener Fische
- `camper` [0, 1]: Haben sie ein Wohnmobil mitgebracht?

<br/>

# Fischfang: Einfaches Poisson-Modell

```{r fish-pois-1, attr.output = "fragment"}
fish_poisson <- glm(count ~ camper, family = poisson(), data = fish)

tidy(fish_poisson, exponentiate = FALSE) %>%
  transmute(term, estimate, exp_estimate = exp(estimate)) %>%
  kable(
    format = "html", digits = 2,
    caption = "Poisson-Modell: count ~ camper",
    col.names = c("Term", "Koeffizient", "Koeffizient (exp)")
  ) %>%
  kable_styling()
```

- `camper1`: Gruppen, die einen Wohnwagen mitbrachten, fingen ~3 mal so viele Fische wie Gruppen ohne Wohnwagen
- Wenn ein *exposure*-Parameter / `offset` hinzugefügt wird (z.B. `log(days)`), entspräche der Koeffizient einer **rate ratio**

# Ein Blick auf die Daten

```{r fish-summary}
fish %>%
  summarize(
    Mean = mean(count), Var = var(count), Min = min(count), Max = max(count)
  ) %>%
  kable(caption = "Summary: count") %>%
  kable_styling()
  
fish %>%
  filter(count <= 20) %>%
  count(camper, count) %>%
  ggplot(aes(x = count, y = n, fill = camper)) +
  geom_col(position = position_dodge2(preserve = "single")) +
  scale_fill_brewer(palette = "Set2", labels = c("Ohne Camper", "Mit Camper")) +
  labs(
    title = "fish: Barchart nach camper",
    subtitle = "x-Achse limitiert auf [0, 20]",
    x = "Anzahl Fische", y = "Count", fill = ""
  ) +
  theme(legend.position = "bottom")
```

# Problem 1: Overdispersion

Zentrale Eigenschaft der Poisson: **Equidispersion**

$$
\mu = \mathbb{E}(Y) = \mathbb{V}(Y)
$$

- Poisson–**Over**dispersion: $\mathbb{E}(Y) < \mathbb{V}(Y)$
  - -> **Unter**schätzte Standardfehler
- Poisson–**Under**dispersion: $\mathbb{E}(Y) > \mathbb{V}(Y)$  
  - -> **Über**schätzte Standardfehler
  
<br>
- Allgemeine Overdispersion: $\mathbb{V}(Y\ |\ X) > \mathbb{V}(Y)$

# Overdispersion (2)

Mögliche Gründe:

- Fehlspezifiziertes Modell (fehlende Prädiktoren, Transformationen...)
- Korrellierte Daten / verletzte Unabhängigkeitsannahme
   - -> robuste Varianzschätzer (sandwich)
- Ausreißer
- Missing values (MNAR)
- Zero-Inflation <small>(dazu später mehr)</small>
- etc. pp.

# Overdispersion (3): Dispersionsstatistik

Für prinzipiell alle Modell anwendbar:

$$
D = \frac{\chi_{\text{Pearson}}^2}{\mathrm{df}}
$$

- $D = 1$: Poisson!
- $D > 1$: Overdispersion
- $D < 1$: Underdispersion
- Over/underdispersion jeweils **relativ zum Modell**!

# Problem 2: Zero-Inflation

- Wenn das Modell deutlich weniger Nullen vorhersagt, als tatsächlich vorliegen
- Erhöht Modellvarianz, verzerrt bedingten Erwartungswert
- Kontrolle: Beobachtete und erwartete Häufigkeiten des Modells vergleichen

<br/>
<div class="fragment">
```{r compare-observed-expected}
observed_v_expected <- fish %>%
  count(count, name = "observed") %>%
  mutate(
    expected = purrr::map_dbl(count, ~{
                  dpois(.x, fitted(fish_poisson)) %>%
                    sum() %>%
                    round(2)
                }),
    difference = observed - expected
  ) 

observed_v_expected %>%
  head(3) %>%
  kable(
    caption = "fish: Observed + expected counts",
    col.names = c("Fische", "Beobachtet", "Erwartet (Poisson)", "Differenz"),
  ) %>%
  kable_styling()
```
</div>

# Modelle

```{r model-graph-png, fig.align="center", out.width="60%"}
knitr::include_graphics(here::here("graphs/model-graph.dot.png"))
```

# Zero-Inflated Modell

*Mixture distribution*: Count-Modell gemischt mit Null-Modell

- **Zero-Inflated Poisson**: Poisson-Verteilung gemischt mit Nullverteilung
- Mixture proportion: $\pi \in [0, 1]$

$$
\begin{aligned}
P(Y = 0) &= \pi + (1-\pi) \cdot e^{-\mu} \\
P(Y = y) &= (1 - \pi) \cdot \frac{\mu^y e^{-\mu}}{y!}, \quad y = 1, 2, 3, \ldots
\end{aligned}
$$
## ZI (2): Grundidee

Annahme:  
- Es gibt 0-counts aus zwei unterschiedlichen Prozessen
- Beispiel `fish`: 
  - Nicht alle Gruppen haben am Wochenende geangelt!
  - *Alle* wurde nach der Anzahl der Fische befragt
  
```{r zi-principle-plot}
nsim <- 10^4
meansim <- 2

tibble::tibble(
  counts = rpois(n = nsim, lambda = meansim),
) %>%
  count(counts, name = "Poisson") %>%
  mutate(
    Zeros = floor(Poisson/2),
    Zeros = ifelse(counts > 0, 0, Zeros)
  ) %>%
  gather(source, freq, Poisson, Zeros) %>%
  mutate(source = forcats::fct_rev(source),
         freq = freq/nsim) %>%
  ggplot(aes(x = counts, y = freq, fill = source)) +
  geom_col(alpha = .75) +
  scale_x_continuous(breaks = seq(0, 12)) +
  scale_fill_brewer(palette = "Set1", labels = c(Zeros = "Certain Zeros", Poisson = "Poisson-Modell")) +
  labs(
    title = "Schaubild: Zero-Inflated Poisson",
    subtitle = "Nullen in den Daten: Certain zeros + count zeros",
    x = "Count", y = "Anteil an Gesamtsichtprobe", fill = "",
    caption = "Simulierte Daten"
  ) +
  theme(legend.position = "bottom")
```



# Extrembeispiel

- Mittelwert = 0.00088
- Varianz = 0.00088
- Dispersion = 0.76
- Expected counts (Poisson) ≈ Observed counts (± 0.01%)

```{r extrembeispiel-barchart}
knitr::include_graphics("img/extrembeispiel-barchart.png")
```


# Done!

>- In Voll: [poisson.tadaa-data.de](https://poisson.tadaa-data.de)
>- Source: [git.tadaa-data.de/lukas/poisson-regression](git.tadaa-data.de/lukas/poisson-regression)
