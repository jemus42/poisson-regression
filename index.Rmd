--- 
title: "Poisson-Regression und ihre Leiden"
author: "Lukas Burk"
date: "Stand: `r format(Sys.time(), '%d. %B %Y, %H:%M Uhr')`"
lang: de-DE
site: bookdown::bookdown_site
url: ''
documentclass: scrartcl
bibliography: ["Poisson.bib"]
biblio-style: apalike
link-citations: yes
colorlinks: true
description: "Because count data is hard"
papersize: a4
mainfont: "TeX Gyre Pagella"
sansfont: "TeX Gyre Heros"
monofont: "Fira Mono"
monofontoptions:
  - Mapping=tex-ansi
  - Scale=0.75
mathfont: "Asana Math"
always_allow_html: yes
---

```{r setup, include=FALSE}
options(
  knitr.table.format = ifelse(knitr::is_html_output(), "html", "latex")
)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = 1/1.618,
  comment = "#>",
  tidy = FALSE # "formatR",
  # tidy.opts = list(blank = FALSE, width.cutoff = 80)
)

# Load packages ----
# Data transformation & modelling
library(dplyr)
library(broom)

# Tables
library(kableExtra)
library(pander)

# Plotting
library(ggplot2)

theme_set(
   theme_minimal()
)

# library(firasans) # Install via  remotes::install_github("hrbrmstr/firasans")
# theme_set(
#    theme_ipsum_fsc()
# )

# Graphs (GraphViz)
library(DiagrammeR)

# Read data ----
fish <- readRDS("data/fish.rds")
```


# Einführung 

Dieses Dokument soll einen Überblick zum Umgang mit Zähldaten (*count data*) liefern.  
Zähldaten können im Allgemeinen mittels Poissonverteilung modelliert werden, wobei in der Praxis einige Komplikationen zu erwarten sind:

- Over-/underdispersion (siehe Abschnitt \@ref(dispersion)): Die Poissonverteilung besitzt nur einen Parameter für sowohl Erwartungswert als auch Varianz und nimmt somit *equidispersion* an – diese Annahme ist meist in Form von overdispersion verletzt
- Zero-Inflation (siehe Abschnitt \@ref(zeros)): Aus einem Modell lässt sich die erwartete Anzahl an Beobachtungen mit Anzahl $0$ bestimmen – wenn die beobachtete Anzahl (bzw. der Anteil) an Nullen deutlich größer ist, spricht man von *zero-inflation*

Diese Umstände benötigen in der Regel Generalisierungen der einfach Poisson-Regression, entweder durch Erweiterung der Verteilung um zusätzliche Parameter (siehe z.B. *Negative Binomialverteilung* für overdispersion in Abschnitt \@ref(mod-nb), *Generalized Poisson* für underdispersion in Abschnitt \@ref(mod-gp)) oder die Konstruktion von *mixture models* oder *hurdle models* für zero-inflation (Abschnitte \@ref(mod-zi) und  \@ref(mod-hurdle)).

## Datenbeispiele {#data}

```{r datasets}
tribble(
   ~dataset, ~rpkg, ~access, ~source,
   "`azprocedure`", "`COUNT`", "`data(\"azprocedure\", package = \"COUNT\")`", "[@hilbeModelingCountData2014]",
   "`fish`", "–", "https://stats.idre.ucla.edu/stat/sas/code/fish.sas7bdat", "stats.idre.ucla.edu"
) %>%
  setNames(c("Dataset", "`R` Package", "Access", "Quelle")) %>%
  kable(booktabs = TRUE, escape = FALSE, linesep = "") %>%
  kable_styling(position = "center", protect_latex = TRUE)
```

Daten aus @hilbeModelingCountData2014 sind zusätzlich verfügbar als CSV (`HILBE-MCD-CVS-data`) auf [der Website des Autors](https://works.bepress.com/joseph_hilbe/58/).  

Die Datensätze des UCLA IDRE können wie folgt eingelesen werden:

```r
fish <- haven::read_sas("https://stats.idre.ucla.edu/stat/sas/code/fish.sas7bdat")

# Cache locally
saveRDS(fish, "data/fish.rds")
```

Um Daten aus `R` direkt in SAS-Format zu speichern, kann folgender Code unter Verwendung des packages [`haven`](https://haven.tidyverse.org/) verwendet werden:

```r
if (!("haven" %in% installed.packages())) {
   install.packages("haven")
}

data("azprocedure", package = "COUNT")
haven::write_sas(azprocedure, "path/to/saved/file.sas7bdat")
```

## Verwendete Software

Zur Reproduktion der Beispiele sind insbesondere die folgenden `R` packages notwendig, die durch den angegebenen Code bei installiert werden, sofern sie nicht bereits verfügbar sind:

```r
if (!("dplyr" %in% installed.packages())) install.packages("dplyr")

# Plots
if (!("ggplot2" %in% installed.packages())) install.packages("ggplot2")

# Data
if (!("COUNT" %in% installed.packages())) install.packages("COUNT")

# Output formatting
if (!("pander" %in% installed.packages())) install.packages("pander")
```

Siehe auch Anhang \@ref(reproduzierbarkeit).

Weiterhin werden einige Hilfsfunktionen im Laufe des Dokuments verwendet, die lediglich der Abkürzung und/oder der Formatierung des Outputs dienen:

```{r helper_functions}
describe_counts <- function(x) {
   tibble(
      n = length(x),
      mean = mean(x),
      var = var(x)
   ) %>%
   setNames(c("N", "Mittelwert", "Varianz")) %>%
   kable(booktabs = TRUE, escape = FALSE, linesep = "") %>%
   kable_styling(position = "center", protect_latex = TRUE)
}

```

