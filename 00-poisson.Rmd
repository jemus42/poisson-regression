---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Das Poisson-Modell {#mod-pois}

Das Poisson-Modell stellt die Grundlage für die meisten der folgenden Modelle dar, und verdient daher eine genauere Betrachtung.

```{definition, name = "Poisson-Verteilung"}
Eine Poisson-verteilte Zufallsvariable $Y \sim \mathrm{Poi}(\lambda)$ [^poiparam] hat die Dichte

\begin{equation*}
\mathrm{P}(Y = y) = \frac{\lambda^y \exp(-\lambda)}{y!} \quad, y \in \mathbb{N}_0
\end{equation*}
```

```{r poisson_dists, echo=FALSE}
purrr::map_df(c(0.5, seq(1, 10, 3)), ~{
  tibble(
    lambda = .x,
    x = 0:20,
    poi = dpois(x, lambda)
  )
}) %>%
  ggplot(aes(x = x, y = poi, color = factor(lambda), fill = factor(lambda))) +
  geom_path(aes(group = lambda), linetype = "dotted") +
  geom_point(shape = 21, color = "black", size = 2.5, stroke = .2) +
  #geom_segment(aes(x = x, xend = x, y = 0 , yend = poi)) +
  scale_color_viridis_d(direction = -1, guide = FALSE) +
  scale_fill_viridis_d(direction = -1, guide = guide_legend()) +
  labs(
    title = expression(Poi(lambda)),
    x = "y", y = expression(Poi(y, lambda)), fill = expression(lambda)
  ) +
  theme(legend.position = "top")
```

```{definition, name = "Poisson-Modell"}
Die Zielvariablen $y_i \in \mathbb{N}_0$ sind (bedingt) unabhängig gegeben der Kovariablen $x_i1, x_i2, \ldots, x_ik$.

Die Rate $\lambda_i = \mathbb{E}(y_i\ |\ \mathbf{x}_i)$ der Poissonverteilung wird in der Regel log-linear modelliert als

\begin{align*}
  \log(\lambda_i) &= \eta_i 
    = \mathbf{x}_i^\prime \boldsymbol{\beta} 
    = \beta_0 + \beta_1 x_1 + \ldots + \beta_k x_{ik} \\
  \lambda_i &= \exp(\eta_i) 
    = \exp(\beta_0) \cdot \exp(\beta_1 x_1) \cdot \ldots \cdot \exp(\beta_k x_k)
\end{align*}

```


[^poiparam]: Der Poisson-Parameter wird von unterschiedlichen Autoren als $\lambda$ oder $\mu$ bezeichnet, und ich habe mich noch nicht für eine Variante entschieden).


Vgl. @fahrmeirRegressionModelleMethoden2009

Für das log-lineare Poisson-Modell entsprechen die resultierenden Koeffizienten der Veränderung der log-counts – durch Exponentiation lassen diese sich als *incidence rate ratios* (*IRR*) interpretieren.

## Annahmen

1. Die Abhängige / Zielvariable $Y$ muss eine Zählung sein, i.e. die Verteilung ist diskret mit einem einzelnen Parameter $\lambda$ der Poisson-Verteilung für Erwartungswert und Varianz.
2. $y \in \mathbb{N}_0$, insbesondere: $Y$ muss 0 enthalten *können* (siehe auch \@ref(trunc-cens) [Truncation und Censoring](#trunc-cens))
3. Beobachtungen sind *unabhängig*, i.e. weder longitudinal noch gepoolt.
   - Möglicher Test durch Vergleich der Modell-SE und der SE adjustiert durch:
   - 1. Robuste sandwich-estimators
   - 2. Bootstrapped SEs
   - 3. SE skaliert mit der $\chi^2$-Dispersionsstatistik: $se \cdot \sqrt{\chi^2}$
   - Große Unterschiede implizieren korrelierte Daten
4. Balanced: Die Zellen sind in etwa so besetzt wie es aufgrund der Poissonverteilung erwartet wird.
5. Erwartungswert und Varianz sind identisch (*equidispersion*), i.e. ein größerer Erwartungswert impliziert auch eine größere Varianz.
6. Die $\chi^2$-Statistik hat einen Wert nahe 1, i.e. beobachtete und erwartete Varianzen der response sind gleich (Dispersionsindex)
   - Check auf overdispersion: Boundary likelihood ratio test

(Nach Tabelle in [@hilbeModelingCountData2014], braucht noch Deduplizierung)

Alternative Formulierung nach @winkelmannEconometricAnalysisCount2010 (p. 64):

1. $f(y\ |\ \lambda) = \frac{e^{-\lambda} \lambda^y}{y!} \quad \lambda > 0, y = 0, 1, 2, \ldots$.
2. $\lambda = \exp(\mathbf{x}' \boldsymbol{\beta})$.
3. Beobachtungspaare $(y_i, x_i)$ sind unabhängig verteilt.

## Offset

Ein Offset wird benötigt, um auf ungleiche Expositionsdauern oder -gebiete zu adjustieren. Dazu dient der Koeffizient $t$, der die Länge der Zeit unter Exposition angibt:

\begin{equation}
f(y, \mu) = \frac{\exp(\mu) (t \mu)^y}{y!}
\end{equation}

Damit entspricht $t \mu$ der Inzidenzrate des Outcomes adjustiert auf e.g. die geographische Lage oder Expositionsdauer. Ohne Offset entspräche $t = 1$.
Für als Offset wird in der Regel $\log(t)$ verwendet, womit gelten:

\begin{align*}
\hat{\lambda} &= \exp{x \boldsymbol{\beta} + \log(t)} \\
\Leftrightarrow \exp(x \boldsymbol{\beta}) &= \frac{\hat{\lambda}}{t} \\
\Leftrightarrow \hat{\lambda} &= t \exp(x \boldsymbol{\beta})
\end{align*}


In `R`:

```{r mod_pois_offset, eval = FALSE}
data(fasttrakg, package = "COUNT")

glm(die ~ anterior + hcabg + factor(killip), data = fasttrakg, 
family = poisson(), offset = log(cases))
```
