---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Modelle 

Ein Überblick einiger Modelle mit parametrisierter Varianz (nach @hilbeModelingCountData2014, p. 12).

```{r models_table_1, echo=FALSE}
tibble::tribble(
  ~Model,                         ~Mean,  ~Variance,
  "Poisson",                     "$\\mu$", "$\\mu$",
  "Negative Binomial (NB1)",     "$\\mu$", "$\\mu (1 + \\alpha) = \\mu + \\alpha\\mu$",
  "Negative Binomial (NB2)",     "$\\mu$", "$\\mu (1 + \\alpha\\mu) = \\mu + \\alpha\\mu^2$",
  "Poisson Inverse Gamma (PIG)", "$\\mu$", "$\\mu (1 + \\alpha\\mu^2) = \\mu + \\alpha\\mu^3$",
  "Negative binomial-P (NBP)",   "$\\mu$", "$\\mu (1 + \\alpha\\mu^p) = \\mu + \\alpha\\mu^p$",
  "Generalized Poisson (GP)",    "$\\mu$", "$\\mu (1 + \\alpha\\mu)^2 = \\mu + 2\\alpha\\mu^3 + \\alpha^2\\mu^3$"
 ) %>%
  kable(booktabs = TRUE, escape = FALSE, linesep = "") %>%
  kable_styling(position = "center", protect_latex = TRUE)
```


## Poisson {#mod-pois}

Das Poisson-Modell stellt die Grundlage für die meisten der folgenden Modelle dar, und verdient daher eine genauere Betrachtung.

```{definition, name = "Poisson-Modell"}
Eine Poisson-verteilte Zufallsvariable $Y \sim \mathrm{Poi}(\lambda)$ [^poiparam] hat die Dichte

\begin{equation}
f(y\ |\ \lambda) = \mathrm{P}(Y = y) = \frac{\lambda^y \exp(-\lambda)}{y!} \quad, y \in \mathbb{N}_0
\end{equation}

Die Rate $\lambda_i = \mathbb{E}(y_i | x_i)$ der Poissonverteilung wird in der Regel log-linear modelliert als

\begin{equation}
\log(\lambda_i) = \eta_i = \mathbf{x}_i^\prime \boldsymbol{\beta} = \beta_0 + \beta_1 x_1 + \ldots + \beta_k x_{ik}
\end{equation}

mit der regulären Form:

\begin{equation}
\lambda_i = \exp(\eta_i) = \exp(\beta_0) \cdot \exp(\beta_1 x_1) \cdot \ldots \cdot \exp(\beta_k x_k)
\end{equation}
```


[^poiparam]: Der Poisson-Parameter wird von unterschiedlichen Autoren als $\lambda$ oder $\mu$ bezeichnet, und ich habe mich noch nicht für eine Variante entschieden).


Vgl. @fahrmeirRegressionModelleMethoden2009

Für das log-lineare Poisson-Modell entsprechen die resultierenden Koeffizienten der Veränderung der log-counts – durch Exponentiation lassen diese sich als *incidence rate ratios* (*IRR*) interpretieren.

### Annahmen

Primäre Annahme für Poisson-Modelle: *Equidispersion*, i.e. für den Parameter der Poissonverteilung gilt 


1. Die Abhängige / Zielvariable $Y$ muss eine Zählung sein, i.e. die Verteilung ist diskret mit einem einzelnen Parameter $\lambda$.
2. $y \in \mathbb{N}_0$, insbesondere: $Y$ muss 0 enthalten können (siehe auch \@ref(trunc-cens) [Truncation und Censoring](#trunc-cens))
3. Beobachtungen sind unabhängig, i.e. weder longitudinal noch gepoolt.
   - Möglicher Test durch Vergleich der Modell-SE und der SE adjustiert durch:
   - 1. Robuste sandwich-estimators
   - 2. Bootstrapped SEs
   - 3. SE skaliert mit der $\chi^2$-Dispersionsstatistik: $se \cdot \sqrt{\chi^2}$
   - Große Unterschiede implizieren korrelierte Daten
4. Balanced: Die Zellen sind in etwa so besetzt wie es aufgrund der Poissonverteilung erwartet wird.
5. Erwartungswert und Varianz sind identisch (*equidispersion*), i.e. ein größerer Erwartungswert impliziert auch eine größere Varianz.
6. Die $\chi^2$-Statistik hat einen Wert nahe 1, i.e. beobachtete und erwartete Varianzen der response sind gleich (Dispersionsindex)
   - Check auf overdispersion: Boundary likelihood ratio test

(Tabelle nach [@hilbeModelingCountData2014], braucht noch Deduplizierung)

### Offset

Ein Offset wird benötigt, um auf ungleiche Expositionsdauern oder -gebiete zu adjustieren. Dazu dient der Koeffizient $t$, der die Länge der Zeit unter Exposition angibt:

\begin{equation}
f(y, \mu) = \frac{\exp(mu) (t\mu)^y}{y!}
\end{equation}

Damit entspricht $t\mu$ der Inzidenzrate des Outcomes adjustiert auf e.g. die geographische Lage oder Expositionsdauer. Ohne Offset entspräche $t = 1$.
Für als Offset wird in der Regel $\log(t)$ verwendet, womit gelten:

\begin{align*}
\hat{\lambda} &= \exp{x \boldsymbol{\beta} + \log(t)} \\
\Leftrightarrow \exp(x \boldsymbol{\beta}) &= \frac{\hat{\mu}}{t} \\
\Leftrightarrow \hat{\mu} &= t \exp(x \boldsymbol{\beta})
\end{align*}


In `R`:

```{r mod_pois_offset, eval = FALSE}
data(fasttrakg, package = "COUNT")

glm(die ~ anterior + hcabg + factor(killip), data = fasttrakg, 
family = poisson(), offset = log(cases))
```


## Negative Binomial (NB) {#mod-nb}

- Derivation: Poisson-Gamma Mischmodell
- Erweiterung der Poissonverteilung um einen Dispersionsparameter $\alpha$
  - Wenn $\alpha > 0$: overdispersion
  - Wenn $\alpha = 0$: Äquivalent zu Poisson
- Interpretation der exponentierten Koeffizienten: IRRs
- Zwei Varianten: NB1, NB2
- Software Pitfalls:
  - Dispersionsparameter in R's `glm` bzw. `MASS::glm.nb` invertiert: $\theta = \frac 1 \alpha$
  - -> Äquivalenz zu Poisson bei $\theta \to \infty$
  
> "The negative binimial model adjusts for Poisson overdispersion; it cannot be used to model underdispersed Poisson data" 
> [@hilbeModelingCountData2014, p. 11]
  
  
Vgl @hilbeModelingCountData2014

## Poisson Inverse Gaussian (PIG) {#mod-pig}

- Annahme: Overdispersion besser über *inverse Gaussian* Verteilung als Gamma-Verteilung (siehe NBIN) beschreibbar

- Dispersionsparameter $\alpha$, Interpretation analog NBIN
- Interpretation der exponentierten Koeffizienten: IRRs

- Software:
- R: `gamlss` (CRAN)
- Stata: `pigreg` ()

## Negative binomial-P (NB-P) {#mod-nbp}

- NB: Varianz statisch für alle Beobachtungen
- -> NB-P: Varianz kann für Beobachtungen variieren (Parameter $\rho$)

- Primärer Anwendungsfall: Bestimmen, ob NB1 oder NB2 besser passt
  - Wenn $\rho \approx 2$ -> NB2, sonst NB1 (@hilbeModelingCountData2014, p. 21)

## Generalized Poisson {#mod-gp}

- Auch mit dispersion/scale Parameter $\alpha$
- Analog NB: $\alpha = 0 \Rightarrow y \sim \mathrm{Pois}(\lambda)$
- Selling feature: $\alpha < 0$ ist möglich, im Gegensatz zu NB
- -> Underdispersion modellierbar

- Software: 
- [Vgl. Stackexchange Kommentar von Joseph Hilbe](https://stats.stackexchange.com/a/237177/80056)
- R: [`VGAM`](https://rdrr.io/cran/VGAM/man/genpoisson.html)

## Heterogenous Negative Binomial (NBH) {#mod-nbh}

- Selling feature: Erlaubt Parametrisierung von $\alpha$
- -> Ursache für under-/overdispersion modellierbar
